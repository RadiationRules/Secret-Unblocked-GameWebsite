<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iLearn - Schooling Academy - Secret Gaming Hub</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    body {
      margin: 0; padding: 0;
      background: #0f0f1a;
      color: #0ff;
      font-family: 'Share Tech Mono', monospace;
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: #fff;
      color: #005f99;
    }
    header {
      text-align: center;
      padding: 25px 15px 20px;
      font-size: 2.6rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      color: #0ff;
      text-shadow:
        0 0 5px #0ff,
        0 0 10px #0ff,
        0 0 20px #0ff,
        0 0 40px #0ff;
      user-select: none;
      background: #070718;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    body.light header {
      color: #005f99;
      text-shadow:none;
      background: #f0faff;
      border-bottom: 1px solid #ccc;
    }
    #darkToggle {
      position: absolute;
      top: 18px;
      right: 20px;
      cursor: pointer;
      background: transparent;
      border: 2px solid #0ff;
      border-radius: 6px;
      color: #0ff;
      font-family: monospace;
      font-weight: 700;
      padding: 6px 12px;
      user-select: none;
      transition: all 0.3s ease;
    }
    body.light #darkToggle {
      border-color: #005f99;
      color: #005f99;
    }

    #search-container {
      max-width: 600px;
      margin: 20px auto 15px;
      text-align: center;
    }
    #search-input {
      width: 90%;
      max-width: 600px;
      padding: 12px 20px;
      font-size: 1.3rem;
      border-radius: 6px;
      border: 2px solid #0ff;
      background: transparent;
      color: #0ff;
      box-shadow:
        0 0 8px #0ff inset;
      transition: all 0.3s ease;
    }
    #search-input::placeholder {
      color: #0ff99;
    }
    body.light #search-input {
      border-color: #005f99;
      color: #005f99;
      background: #f9f9f9;
    }
    body.light #search-input::placeholder {
      color: #0077cc88;
    }

    #filters, #sort-select, #favorites-btn, #recent-btn, #submit-game-btn {
      max-width: 600px;
      margin: 0 auto 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      user-select: none;
    }
    select, button {
      font-family: monospace;
      font-size: 1rem;
      border-radius: 6px;
      border: 2px solid #0ff;
      background: transparent;
      color: #0ff;
      cursor: pointer;
      padding: 6px 12px;
      transition: all 0.3s ease;
    }
    select:focus, button:focus, input:focus {
      outline: none;
      border-color: #3ff;
      box-shadow: 0 0 8px #0ff;
    }
    body.light select, body.light button {
      border-color: #005f99;
      color: #005f99;
      background: #f9f9f9;
    }
    body.light select:focus, body.light button:focus, body.light input:focus {
      border-color: #0077cc;
      box-shadow: 0 0 8px #005f99;
    }

    #games-list {
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(260px,1fr));
      gap: 15px;
      padding: 0 15px 60px;
      max-width: 960px;
      margin: 0 auto;
    }
    .game-card {
      background: rgba(0,255,255,0.1);
      border: 1.5px solid #0ff;
      border-radius: 8px;
      padding: 15px 20px;
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      cursor: pointer;
      color: #0ff;
      user-select: none;
      text-align: center;
      font-weight: 600;
      font-size: 1.1rem;
      text-decoration: none;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 120px;
      position: relative;
    }
    body.light .game-card {
      border-color: #005f99;
      background: #f0f9ff;
      color: #005f99;
    }
    .game-card:hover, .game-card:focus {
      transform: scale(1.07);
      box-shadow:
        0 0 15px #0ff,
        0 0 40px #0ff;
      outline: none;
      z-index: 10;
    }
    body.light .game-card:hover, body.light .game-card:focus {
      box-shadow:
        0 0 15px #005f99,
        0 0 40px #005f99;
    }

    .game-title {
      flex-grow: 1;
      margin-bottom: 10px;
      user-select: text;
    }
    .game-actions {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 0.9rem;
      color: #0ff;
    }
    body.light .game-actions {
      color: #005f99;
    }
    .btn-small {
      background: transparent;
      border: none;
      color: inherit;
      cursor: pointer;
      user-select: none;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: color 0.3s ease;
    }
    .btn-small:hover, .btn-small:focus {
      color: #3ff;
      outline: none;
    }
    .star-rating {
      display: flex;
      gap: 2px;
    }
    .star {
      width: 18px;
      height: 18px;
      cursor: pointer;
      fill: #0ff;
      transition: fill 0.3s ease;
    }
    .star.empty {
      fill: transparent;
      stroke: #0ff;
      stroke-width: 1.5px;
    }
    body.light .star {
      fill: #005f99;
      stroke: #005f99;
    }
    body.light .star.empty {
      fill: transparent;
      stroke: #005f99;
    }
    .star:hover, .star.hovered, .star.selected {
      fill: #3ff;
      stroke: #3ff;
    }

    /* Modal for preview */
    #preview-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 15px;
      user-select: none;
    }
    #preview-modal.active {
      display: flex;
    }
    #preview-content {
      max-width: 95vw;
      max-height: 85vh;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 0 20px #0ff;
    }
    #preview-iframe {
      width: 100%;
      height: 80vh;
      border: none;
      display: block;
    }
    #close-preview {
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 2rem;
      color: #0ff;
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      padding: 0 8px;
      transition: color 0.3s ease;
    }
    #close-preview:hover, #close-preview:focus {
      color: #3ff;
      outline: none;
    }
    body.light #preview-modal {
      background: rgba(255,255,255,0.95);
    }
    body.light #preview-content {
      background: #fff;
      box-shadow: 0 0 20px #005f99;
    }
    body.light #close-preview {
      color: #005f99;
      background: rgba(255,255,255,0.8);
    }
    body.light #close-preview:hover, body.light #close-preview:focus {
      color: #0077cc;
    }

    /* Comments and review form */
    #comments-section {
      max-width: 600px;
      margin: 15px auto 50px;
      padding: 10px 20px;
      background: rgba(0,255,255,0.08);
      border-radius: 10px;
      border: 1px solid #0ff;
      font-size: 0.9rem;
      color: #0ff;
      user-select: text;
    }
    body.light #comments-section {
      background: #e6f2ff;
      border-color: #005f99;
      color: #005f99;
    }
    #comments-list {
      max-height: 160px;
      overflow-y: auto;
      margin-bottom: 10px;
      border-top: 1px solid #0ff;
      padding-top: 8px;
    }
    body.light #comments-list {
      border-top-color: #005f99;
    }
    .comment {
      margin-bottom: 8px;
      border-bottom: 1px dotted #0ff;
      padding-bottom: 5px;
    }
    body.light .comment {
      border-color: #005f99;
    }
    #comment-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #comment-input {
      flex-grow: 1;
      min-width: 200px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1.5px solid #0ff;
      background: transparent;
      color: #0ff;
      resize: vertical;
    }
    body.light #comment-input {
      border-color: #005f99;
      background: #fff;
      color: #005f99;
    }
    #comment-submit {
      background: #0ff;
      border: none;
      padding: 8px 20px;
      font-weight: 700;
      color: #000;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }
    #comment-submit:hover, #comment-submit:focus {
      background: #3ff;
      outline: none;
    }
    body.light #comment-submit {
      background: #005f99;
      color: #fff;
    }
    body.light #comment-submit:hover, body.light #comment-submit:focus {
      background: #0077cc;
    }

    /* Share link button */
    #share-link-btn {
      margin-left: auto;
      background: transparent;
      border: 1.5px solid #0ff;
      color: #0ff;
      font-size: 0.9rem;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #share-link-btn:hover, #share-link-btn:focus {
      background: #0ff;
      color: #000;
      outline: none;
    }
    body.light #share-link-btn {
      border-color: #005f99;
      color: #005f99;
    }
    body.light #share-link-btn:hover, body.light #share-link-btn:focus {
      background: #005f99;
      color: #fff;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #111122;
    }
    ::-webkit-scrollbar-thumb {
      background: #0ff;
      border-radius: 20px;
    }
    body.light ::-webkit-scrollbar-track {
      background: #eee;
    }
    body.light ::-webkit-scrollbar-thumb {
      background: #005f99;
    }

    /* Responsive */
    @media (max-width: 720px) {
      #games-list {
        grid-template-columns: repeat(auto-fill,minmax(180px,1fr));
      }
      .game-card {
        height: auto;
      }
      #comment-input {
        min-width: 100%;
      }
      #filters, #sort-select, #favorites-btn, #recent-btn, #submit-game-btn {
        flex-direction: column;
        align-items: stretch;
      }
      #darkToggle {
        top: 8px;
        right: 8px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>

<header>
  iLearn - Schooling Academy - Secret Gaming Hub
  <button id="darkToggle" aria-label="Toggle dark mode">Light Mode</button>
</header>

<div id="search-container">
  <input type="search" id="search-input" placeholder="Search games by name, tag, or category..." aria-label="Search games" autofocus autocomplete="off" />
</div>

<div id="filters">
  <select id="category-filter" aria-label="Filter by category">
    <option value="">All Categories</option>
  </select>
  <select id="sort-select" aria-label="Sort games">
    <option value="popularity">Sort by Popularity</option>
    <option value="rating">Sort by Rating</option>
    <option value="alphabet">Sort Alphabetically</option>
    <option value="recent">Sort by Recently Played</option>
  </select>
  <button id="favorites-btn" aria-pressed="false" title="Show Favorites Only">â™¥ Favorites</button>
  <button id="recent-btn" aria-pressed="false" title="Show Recently Played">ðŸ•˜ Recent</button>
  <button id="submit-game-btn" title="Submit a Game">âž• Submit Game</button>
</div>

<div id="games-list" role="list" aria-live="polite" aria-relevant="additions removals"></div>

<!-- Modal Preview -->
<div id="preview-modal" role="dialog" aria-modal="true" aria-labelledby="preview-title" tabindex="-1">
  <div id="preview-content">
    <button id="close-preview" aria-label="Close preview">&times;</button>
    <iframe id="preview-iframe" title="Game Preview"></iframe>
    <div id="comments-section">
      <h3 id="preview-title">Game Comments & Reviews</h3>
      <div id="comments-list" aria-live="polite"></div>
      <form id="comment-form" aria-label="Add a comment">
        <textarea id="comment-input" rows="3" placeholder="Write a comment..." required aria-required="true"></textarea>
        <button type="submit" id="comment-submit">Post Comment</button>
      </form>
    </div>
  </div>
</div>

<!-- Submit game modal -->
<div id="submit-modal" role="dialog" aria-modal="true" aria-labelledby="submit-title" tabindex="-1" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2100; align-items:center; justify-content:center; padding:20px;">
  <form id="submit-form" style="background:#0f0f1a; padding:20px; border-radius:10px; max-width:400px; color:#0ff; display:flex; flex-direction:column; gap:15px;" aria-label="Submit a new game">
    <h2 id="submit-title" style="margin:0 0 10px;">Submit Your Game</h2>
    <label>
      Game Title:
      <input type="text" id="submit-title-input" required style="width:100%; padding:8px; border-radius:6px; border: 1.5px solid #0ff; background:transparent; color:#0ff;" />
    </label>
    <label>
      Game URL:
      <input type="url" id="submit-url-input" required placeholder="https://example.com" style="width:100%; padding:8px; border-radius:6px; border: 1.5px solid #0ff; background:transparent; color:#0ff;" />
    </label>
    <label>
      Categories (comma separated):
      <input type="text" id="submit-categories-input" placeholder="e.g. io, multiplayer, puzzle" style="width:100%; padding:8px; border-radius:6px; border: 1.5px solid #0ff; background:transparent; color:#0ff;" />
    </label>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button type="button" id="submit-cancel-btn" style="background:#880000; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">Cancel</button>
      <button type="submit" style="background:#0ff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; color:#000; font-weight:700;">Submit</button>
    </div>
  </form>
</div>

<script>
(() => {
  const defaultGames = [
    { title: "Agar.io", url: "https://agar.io", categories:["io","multiplayer","action"] },
    { title: "Lurkers.io", url: "https://lurkers.io", categories:["io","multiplayer","action"] },
    { title: "Deeeep.io", url: "https://deeeep.io", categories:["io","multiplayer","survival"] },
    { title: "Slither.io", url: "https://slither.io", categories:["io","multiplayer","action"] },
    { title: "Krunker.io", url: "https://krunker.io", categories:["io","fps","multiplayer"] },
    { title: "Shell Shockers", url: "https://shellshock.io", categories:["io","fps","multiplayer"] },
    { title: "Paper.io 2", url: "https://paper-io.com", categories:["io","strategy","multiplayer"] },
    { title: "WormsZone.io", url: "https://wormszone.io", categories:["io","multiplayer","action"] },
    { title: "Zombs Royale", url: "https://zombsroyale.io", categories:["io","multiplayer","battle-royale"] },
    { title: "Gartic.io", url: "https://gartic.io", categories:["io","multiplayer","drawing"] },
    { title: "Little Big Snake", url: "https://littlebigsnake.com", categories:["io","multiplayer","action"] },
    { title: "FlyOrDie.io", url: "https://flyordie.io", categories:["io","multiplayer","survival"] },
    { title: "2048", url: "https://play2048.co", categories:["puzzle","singleplayer"] },
    { title: "Google Pac-Man", url: "https://www.google.com/search?q=Pacman", categories:["arcade","singleplayer"] },
    { title: "Cookie Clicker", url: "https://orteil.dashnet.org/cookieclicker/", categories:["clicker","singleplayer"] },
    { title: "Tetris.com", url: "https://tetris.com/play-tetris", categories:["puzzle","singleplayer"] },
    { title: "Run 3", url: "https://run3.io", categories:["platformer","singleplayer"] },
    { title: "Moto X3M", url: "https://www.crazygames.com/game/moto-x3m", categories:["racing","singleplayer"] },
    { title: "Google Dino", url: "chrome://dino", categories:["arcade","singleplayer"] },
    { title: "Happy Wheels", url: "https://totaljerkface.com/happy_wheels.tjf", categories:["action","singleplayer"] },
    { title: "Google Snake", url: "https://playsnake.org", categories:["arcade","singleplayer"] },
    { title: "Mini Militia - Doodle Army 2 (mobile)", url: "https://play.google.com/store/apps/details?id=com.appsomniacs.da2", categories:["fps","multiplayer","mobile"] },
    { title: "Among Us (Mobile)", url: "https://innersloth.com/gameAmongUs.php", categories:["multiplayer","social","mobile"] },
    { title: "Aquapark.io", url: "https://yandex.ru/games/app/aquapark-io", categories:["io","multiplayer","racing"] },
    { title: "Basketball Stars", url: "https://yandex.ru/games/app/basketball-stars", categories:["sports","multiplayer"] },
    { title: "Run Race 3D", url: "https://yandex.ru/games/app/run-race-3d", categories:["racing","multiplayer"] },
    { title: "Crowd City", url: "https://yandex.ru/games/app/crowd-city", categories:["io","multiplayer","action"] },
    { title: "Traffic Run!", url: "https://yandex.ru/games/app/traffic-run", categories:["racing","singleplayer"] },
    { title: "Aquapark.io 2", url: "https://yandex.ru/games/app/aquapark-io-2", categories:["io","multiplayer","racing"] },
    { title: "Tanks a Lot", url: "https://yandex.ru/games/app/tanks-a-lot", categories:["io","multiplayer","action"] },
    { title: "Block Puzzle", url: "https://yandex.ru/games/app/block-puzzle", categories:["puzzle","singleplayer"] },
    { title: "Stack Ball", url: "https://yandex.ru/games/app/stack-ball", categories:["arcade","singleplayer"] },
    { title: "Knife Hit", url: "https://yandex.ru/games/app/knife-hit", categories:["arcade","singleplayer"] },
    { title: "Flip Master", url: "https://yandex.ru/games/app/flip-master", categories:["sports","singleplayer"] },
    { title: "Draw Climber", url: "https://yandex.ru/games/app/draw-climber", categories:["puzzle","singleplayer"] },
    { title: "Traffic Run 2", url: "https://yandex.ru/games/app/traffic-run-2", categories:["racing","singleplayer"] },
    { title: "Crowd City 2", url: "https://yandex.ru/games/app/crowd-city-2", categories:["io","multiplayer","action"] },
    { title: "Color Road", url: "https://yandex.ru/games/app/color-road", categories:["arcade","singleplayer"] },
    { title: "Mushroom Revolution", url: "https://yandex.ru/games/app/mushroom-revolution", categories:["strategy","singleplayer"] },
    { title: "Fireboy and Watergirl", url: "https://www.coolmathgames.com/0-fireboy-and-watergirl", categories:["puzzle","multiplayer"] },
    { title: "Zombs.io", url: "https://zombs.io", categories:["io","multiplayer","strategy"] },
    { title: "Poki.io", url: "https://poki.io", categories:["io","multiplayer"] },
    { title: "Duck Life", url: "https://www.crazygames.com/game/duck-life", categories:["simulation","singleplayer"] },
    { title: "Super Mario 63", url: "https://www.supermario63.com", categories:["platformer","singleplayer"] },
    { title: "Flappy Bird", url: "https://flappybird.io", categories:["arcade","singleplayer"] },
    { title: "Miniclip 8 Ball Pool", url: "https://www.miniclip.com/games/8-ball-pool-multiplayer/en/", categories:["sports","multiplayer"] },
    { title: "Geometry Dash", url: "https://www.geometrydashgame.com", categories:["arcade","singleplayer"] }
  ];

  // Load saved user games + merge
  const savedGames = JSON.parse(localStorage.getItem('userGames')||'[]');
  let games = [...defaultGames, ...savedGames];

  // Ratings, favorites, play count, comments stored in localStorage by game URL keys
  function getStorageKey(type, gameUrl) {
    return `${type}_${gameUrl}`;
  }
  function saveToStorage(type, gameUrl, value) {
    localStorage.setItem(getStorageKey(type, gameUrl), JSON.stringify(value));
  }
  function loadFromStorage(type, gameUrl) {
    const item = localStorage.getItem(getStorageKey(type, gameUrl));
    return item ? JSON.parse(item) : null;
  }

  // Favorites management
  const favoritesKey = 'favoriteGames';
  let favorites = JSON.parse(localStorage.getItem(favoritesKey) || '[]');

  // Recently played management
  const recentKey = 'recentlyPlayedGames';
  let recentGames = JSON.parse(localStorage.getItem(recentKey) || '[]');

  // Current filter and sort states
  let currentFilter = '';
  let currentCategory = '';
  let showFavoritesOnly = false;
  let showRecentOnly = false;
  let currentSort = 'popularity';

  // Categories (extract unique categories from all games)
  function extractCategories(gamesList) {
    const set = new Set();
    gamesList.forEach(g => g.categories.forEach(c => set.add(c)));
    return Array.from(set).sort();
  }

  // DOM elements
  const gamesListEl = document.getElementById('games-list');
  const searchInputEl = document.getElementById('search-input');
  const categoryFilterEl = document.getElementById('category-filter');
  const sortSelectEl = document.getElementById('sort-select');
  const favoritesBtn = document.getElementById('favorites-btn');
  const recentBtn = document.getElementById('recent-btn');
  const submitGameBtn = document.getElementById('submit-game-btn');

  // Preview modal elements
  const previewModal = document.getElementById('preview-modal');
  const previewIframe = document.getElementById('preview-iframe');
  const closePreviewBtn = document.getElementById('close-preview');
  const commentsSection = document.getElementById('comments-section');
  const commentsList = document.getElementById('comments-list');
  const commentForm = document.getElementById('comment-form');
  const commentInput = document.getElementById('comment-input');

  // Submit game modal
  const submitModal = document.getElementById('submit-modal');
  const submitForm = document.getElementById('submit-form');
  const submitTitleInput = document.getElementById('submit-title-input');
  const submitUrlInput = document.getElementById('submit-url-input');
  const submitCategoriesInput = document.getElementById('submit-categories-input');
  const submitCancelBtn = document.getElementById('submit-cancel-btn');

  // Dark mode toggle
  const darkToggle = document.getElementById('darkToggle');

  // Share button template
  function createShareButton(url, text, icon) {
    const btn = document.createElement('button');
    btn.className = 'btn-small';
    btn.title = `Share on ${text}`;
    btn.innerHTML = icon;
    btn.addEventListener('click', () => {
      const shareUrl = url;
      if (navigator.share) {
        navigator.share({
          title: 'Secret Gaming Hub - ' + currentGame.title,
          url: shareUrl,
        }).catch(() => alert('Sharing failed'));
      } else {
        prompt('Copy this link to share:', shareUrl);
      }
    });
    return btn;
  }

  // Helper: sanitize text
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, function (m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
    });
  }

  // Create star rating UI for a game
  function createStarRating(game) {
    const container = document.createElement('div');
    container.className = 'star-rating';
    const rating = loadFromStorage('rating', game.url) || 0;

    for(let i=1; i<=5; i++) {
      const star = document.createElementNS('http://www.w3.org/2000/svg','svg');
      star.setAttribute('viewBox','0 0 24 24');
      star.classList.add('star');
      if(i > rating) star.classList.add('empty');
      star.innerHTML = '<path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>';
      star.tabIndex = 0;
      star.setAttribute('role', 'button');
      star.setAttribute('aria-label', `Rate ${i} stars`);
      star.addEventListener('click', () => {
        saveToStorage('rating', game.url, i);
        renderGames(currentFilter);
      });
      star.addEventListener('keydown', e => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          saveToStorage('rating', game.url, i);
          renderGames(currentFilter);
        }
      });
      container.appendChild(star);
    }
    return container;
  }

  // Load comments for a game
  function loadComments(game) {
    return loadFromStorage('comments', game.url) || [];
  }
  // Save comment for a game
  function saveComment(game, comment) {
    const comments = loadComments(game);
    comments.push({ text: comment, date: new Date().toISOString() });
    saveToStorage('comments', game.url, comments);
  }

  // Create favorite toggle button
  function createFavoriteButton(game) {
    const btn = document.createElement('button');
    btn.className = 'btn-small';
    btn.title = favorites.includes(game.url) ? 'Remove from Favorites' : 'Add to Favorites';
    btn.innerHTML = favorites.includes(game.url) ? 'ðŸ’–' : 'ðŸ¤';
    btn.setAttribute('aria-pressed', favorites.includes(game.url));
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      if(favorites.includes(game.url)) {
        favorites = favorites.filter(f => f !== game.url);
      } else {
        favorites.push(game.url);
      }
      localStorage.setItem(favoritesKey, JSON.stringify(favorites));
      renderGames(currentFilter);
    });
    return btn;
  }

  // Record a game play (add to recent list and increment play count)
  function recordPlay(game) {
    // Play count
    let playCount = loadFromStorage('playcount', game.url) || 0;
    playCount++;
    saveToStorage('playcount', game.url, playCount);

    // Recent games
    recentGames = recentGames.filter(g => g !== game.url);
    recentGames.unshift(game.url);
    if(recentGames.length > 20) recentGames.pop();
    localStorage.setItem(recentKey, JSON.stringify(recentGames));
  }

  // Create share link button
  function createShareLinkBtn(game) {
    const btn = document.createElement('button');
    btn.className = 'btn-small';
    btn.id = 'share-link-btn';
    btn.title = 'Copy game link';
    btn.innerHTML = 'ðŸ”— Copy Link';
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      navigator.clipboard.writeText(game.url).then(() => {
        btn.textContent = 'âœ… Copied!';
        setTimeout(() => btn.textContent = 'ðŸ”— Copy Link', 1500);
      }).catch(() => {
        prompt('Copy this link:', game.url);
      });
    });
    return btn;
  }

  // Create game card element
  function createGameCard(game) {
    const a = document.createElement('a');
    a.href = game.url;
    a.target = "_blank";
    a.rel = "noopener noreferrer";
    a.className = 'game-card';
    a.setAttribute('role', 'listitem');
    a.setAttribute('tabindex', '0');
    a.setAttribute('aria-label', `Play game ${game.title}`);

    // Title
    const titleDiv = document.createElement('div');
    titleDiv.className = 'game-title';
    titleDiv.textContent = game.title;
    a.appendChild(titleDiv);

    // Actions container
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'game-actions';

    // Favorite button
    actionsDiv.appendChild(createFavoriteButton(game));

    // Rating stars
    actionsDiv.appendChild(createStarRating(game));

    // Share link button
    actionsDiv.appendChild(createShareLinkBtn(game));

    a.appendChild(actionsDiv);

    // On click - open preview modal with iframe and comments
    a.addEventListener('click', e => {
      e.preventDefault();
      currentGame = game;
      previewIframe.src = game.url;
      loadCommentsForGame(game);
      previewModal.classList.add('active');
      previewModal.focus();
      recordPlay(game);
      renderGames(currentFilter);
    });

    // Keyboard support: open modal on Enter
    a.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        a.click();
      }
    });

    return a;
  }

  // Render games list based on filters, search, sorting
  function renderGames(filter = '') {
    currentFilter = filter.toLowerCase().trim();

    // Prepare filtered games
    let filtered = games.filter(g => {
      let matchesSearch = g.title.toLowerCase().includes(currentFilter) ||
                          (g.categories && g.categories.some(c => c.includes(currentFilter)));

      let matchesCategory = !currentCategory || (g.categories && g.categories.includes(currentCategory));

      let matchesFavorites = !showFavoritesOnly || favorites.includes(g.url);

      let matchesRecent = !showRecentOnly || recentGames.includes(g.url);

      return matchesSearch && matchesCategory && matchesFavorites && matchesRecent;
    });

    // Sorting
    if (currentSort === 'popularity') {
      filtered.sort((a,b) => (loadFromStorage('playcount', b.url) || 0) - (loadFromStorage('playcount', a.url) || 0));
    } else if (currentSort === 'rating') {
      filtered.sort((a,b) => (loadFromStorage('rating', b.url) || 0) - (loadFromStorage('rating', a.url) || 0));
    } else if (currentSort === 'alphabet') {
      filtered.sort((a,b) => a.title.localeCompare(b.title));
    } else if (currentSort === 'recent') {
      filtered.sort((a,b) => {
        const aIndex = recentGames.indexOf(a.url);
        const bIndex = recentGames.indexOf(b.url);
        if(aIndex === -1 && bIndex === -1) return 0;
        if(aIndex === -1) return 1;
        if(bIndex === -1) return -1;
        return aIndex - bIndex;
      });
    }

    // Clear list
    gamesListEl.innerHTML = '';

    // If empty
    if(filtered.length === 0) {
      gamesListEl.textContent = 'No games found.';
      return;
    }

    // Create and append cards
    filtered.forEach(game => {
      gamesListEl.appendChild(createGameCard(game));
    });
  }

  // Load categories into filter dropdown
  function loadCategories() {
    const cats = extractCategories(games);
    cats.forEach(cat => {
      const option = document.createElement('option');
      option.value = cat;
      option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
      categoryFilterEl.appendChild(option);
    });
  }

  // Comment section
  let currentGame = null;
  function loadCommentsForGame(game) {
    currentGame = game;
    commentsList.innerHTML = '';
    const comments = loadComments(game);
    if (comments.length === 0) {
      commentsList.textContent = "No comments yet. Be the first to comment!";
    } else {
      comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment';
        div.textContent = `${new Date(c.date).toLocaleString()}: ${c.text}`;
        commentsList.appendChild(div);
      });
    }
  }

  commentForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = commentInput.value.trim();
    if(text && currentGame) {
      saveComment(currentGame, text);
      commentInput.value = '';
      loadCommentsForGame(currentGame);
    }
  });

  // Close preview modal
  closePreviewBtn.addEventListener('click', () => {
    previewModal.classList.remove('active');
    previewIframe.src = '';
  });
  previewModal.addEventListener('click', e => {
    if(e.target === previewModal) {
      previewModal.classList.remove('active');
      previewIframe.src = '';
    }
  });

  // Search input handler
  searchInputEl.addEventListener('input', () => {
    renderGames(searchInputEl.value);
  });

  // Category filter handler
  categoryFilterEl.addEventListener('change', () => {
    currentCategory = categoryFilterEl.value;
    renderGames(searchInputEl.value);
  });

  // Sort select handler
  sortSelectEl.addEventListener('change', () => {
    currentSort = sortSelectEl.value;
    renderGames(searchInputEl.value);
  });

  // Favorites toggle
  favoritesBtn.addEventListener('click', () => {
    showFavoritesOnly = !showFavoritesOnly;
    favoritesBtn.setAttribute('aria-pressed', showFavoritesOnly);
    if(showFavoritesOnly) recentBtn.setAttribute('aria-pressed', false);
    showRecentOnly = false;
    renderGames(searchInputEl.value);
  });

  // Recent toggle
  recentBtn.addEventListener('click', () => {
    showRecentOnly = !showRecentOnly;
    recentBtn.setAttribute('aria-pressed', showRecentOnly);
    if(showRecentOnly) favoritesBtn.setAttribute('aria-pressed', false);
    showFavoritesOnly = false;
    renderGames(searchInputEl.value);
  });

  // Dark mode toggle
  darkToggle.addEventListener('click', () => {
    document.body.classList.toggle('light');
    const isLight = document.body.classList.contains('light');
    darkToggle.textContent = isLight ? 'Dark Mode' : 'Light Mode';
    localStorage.setItem('darkMode', isLight ? 'light' : 'dark');
  });
  // Load saved mode
  if(localStorage.getItem('darkMode') === 'light') {
    document.body.classList.add('light');
    darkToggle.textContent = 'Dark Mode';
  } else {
    darkToggle.textContent = 'Light Mode';
  }

  // Submit game modal open/close
  submitGameBtn.addEventListener('click', () => {
    submitModal.style.display = 'flex';
    submitTitleInput.focus();
  });
  submitCancelBtn.addEventListener('click', () => {
    submitModal.style.display = 'none';
    submitForm.reset();
  });
  // Submit game form handler
  submitForm.addEventListener('submit', e => {
    e.preventDefault();
    const title = submitTitleInput.value.trim();
    const url = submitUrlInput.value.trim();
    const categoriesRaw = submitCategoriesInput.value.trim();
    if(!title || !url) return alert('Please fill all required fields');
    const categories = categoriesRaw.split(',').map(c => c.trim().toLowerCase()).filter(c => c);
    const newGame = {title, url, categories};
    games.push(newGame);
    // Save user submitted games persistently
    savedGames.push(newGame);
    localStorage.setItem('userGames', JSON.stringify(savedGames));
    loadCategories(); // reload categories incase new one added
    renderGames(searchInputEl.value);
    submitModal.style.display = 'none';
    submitForm.reset();
    alert('Game submitted! It is now available in the list.');
  });

  // Initial setup
  loadCategories();
  renderGames('');

})();
</script>

</body>
</html>
